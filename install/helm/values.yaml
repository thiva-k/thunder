# Copyright (c) 2025, WSO2 LLC. (https://www.wso2.com).
#
# WSO2 LLC. licenses this file to you under the Apache License,
# Version 2.0 (the "License"); you may not use this file except
# in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied. See the License for the
# specific language governing permissions and limitations
# under the License.

deployment:
  replicaCount: 2
  strategy:
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  securityContext:
    readOnlyRootFilesystem: true # This must be false if sqlite is used as the database
    enableRunAsUser: true
    runAsUser: 802
    enableRunAsGroup: true
    runAsGroup: 802
    enableFsGroup: true
    fsGroup: 802
    seccompProfile:
      enabled: false
      type: "RuntimeDefault"
  # Pod termination grace period. K8s API server waits this period after pre stop hook and sending TERM signal
  terminationGracePeriodSeconds: 10
  image:
    # -- Container image registry host name
    registry: "ghcr.io/asgardeo"
    # -- Container image repository name
    repository: "thunder"
    # -- Container image digest
    digest: ""
    # -- Container image tag. Either "tag" or "digest" should be defined
    tag: "0.14.0"
    pullPolicy: "Always"
  startupProbe:
    initialDelaySeconds: 1
    periodSeconds: 2
    failureThreshold: 30
  livenessProbe:
    periodSeconds: 10
  readinessProbe:
    initialDelaySeconds: 1
    periodSeconds: 10
  container:
    port: 8090
  resources:
    limits:
      cpu: 1.5
      memory: 512Mi
    requests:
      cpu: 1
      memory: 256Mi

hpa:
  enabled: true
  maxReplicas: 10
  averageUtilizationCPU: 65
  averageUtilizationMemory: 75

pdb:
  minAvailable: "50%"

nameOverride: ""
fullnameOverride: ""

serviceAccount:
  # The name of the service account to use.
  # If not set and create is true, a name is generated using the fullname template
  name: "thunder-service-account"
  create: true

service:
  port: 8090

ingress:
  className: "nginx"
  commonAnnotations: &commonAnnotations
    nginx.ingress.kubernetes.io/backend-protocol: "HTTPS"
    nginx.ingress.kubernetes.io/affinity: cookie
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    nginx.ingress.kubernetes.io/proxy-buffer-size: 64k
    nginx.ingress.kubernetes.io/proxy-buffering: "on"
    nginx.ingress.kubernetes.io/session-cookie-conditional-samesite-none: "true"
    nginx.ingress.kubernetes.io/session-cookie-hash: sha1
    nginx.ingress.kubernetes.io/session-cookie-name: paf
    nginx.ingress.kubernetes.io/session-cookie-path: /
    nginx.ingress.kubernetes.io/session-cookie-samesite: None
  customAnnotations: &customAnnotations
    {}
  combinedAnnotations:
    !!merge <<: *commonAnnotations
    !!merge <<: *customAnnotations
  hostname: thunder.local
  paths:
    - path: /
      pathType: Prefix
  tlsSecretsName: "thunder-tls"

# Thunder specific configurations
configuration:
  # Server configuration
  server:
    port: 8090
    httpOnly: false
    publicUrl: "https://thunder.local"

  # Gate client configuration
  gateClient:
    hostname: "thunder.local"
    port: 443
    scheme: "https"
    path: "/gate"

  # Developer client configuration
  developerClient:
    path: "/develop"
    clientId: "DEVELOP"
    scopes: "['openid', 'profile', 'email', 'system']"

  # Security configuration
  security:
    certFile: "repository/resources/security/server.cert"
    keyFile: "repository/resources/security/server.key"
    cryptoFile: "repository/resources/security/crypto.key"

  # Database configuration
  database:
    identity:
      # WARNING: Use sqlite only if you are running a single pod.
      type: "postgres" # postgres or sqlite
      # Below two parameters are only required for sqlite
      sqlitePath: "repository/database/thunderdb.db" # Only required for sqlite
      sqliteOptions: "_journal_mode=WAL&_busy_timeout=5000" # Only required for sqlite
      # Below parameters are only required for Postgres
      name: "thunderdb" 
      host: "localhost" 
      port: "5432" 
      username: "asgthunder"
      password: "asgthunder"
      sslmode: "require"
      max_open_conns: 500
      max_idle_conns: 100
      conn_max_lifetime: 3600
    # Runtime database configuration
    runtime:
      # WARNING: Use sqlite only if you are running a single pod.
      type: "postgres" # postgres or sqlite
      # Below two parameters are only required for sqlite
      sqlitePath: "repository/database/runtimedb.db" # Only required for sqlite
      sqliteOptions: "_journal_mode=WAL&_busy_timeout=5000" # Only required for sqlite
      # Below parameters are only required for Postgres
      name: "runtimedb" 
      host: "localhost" 
      port: "5432" 
      username: "asgthunder"
      password: "asgthunder" 
      sslmode: "require"
      max_open_conns: 500
      max_idle_conns: 100
      conn_max_lifetime: 3600 
    user:
      # WARNING: Use sqlite only if you are running a single pod.
      type: "postgres" # postgres or sqlite
      # Below two parameters are only required for sqlite
      sqlitePath: "repository/database/userdb.db" # Only required for sqlite
      sqliteOptions: "_journal_mode=WAL&_busy_timeout=5000" # Only required for sqlite
      # Below parameters are only required for Postgres
      name: "userdb" 
      host: "localhost" 
      port: "5432" 
      username: "asgthunder"
      password: "asgthunder" 
      sslmode: "require"
      max_open_conns: 500
      max_idle_conns: 100
      conn_max_lifetime: 3600 

  # Cache configuration
  cache:
    disabled: false
    type: "inmemory"
    size: 1000
    ttl: 3600
    evictionPolicy: "LRU"
    cleanupInterval: 300

  # Token Configuration
  jwt:
    validityPeriod: 3600
    audience: "application"

  # OAuth configuration
  oauth:
    refreshToken:
      renewOnGrant: false
      validityPeriod: 86400
    authorizationCode:
      validityPeriod: 600

  # Flow configuration
  flow:
    graphDirectory: "repository/resources/graphs/"
    authn:
      defaultFlow: "auth_flow_config_basic"

  # CORS configuration
  cors:
    allowedOrigins:
      - "https://localhost:3000"

# Persistence configuration for SQLite databases
# Only relevant when using SQLite as the database type
persistence:
  enabled: false
  storageClass: ""
  accessMode: ReadWriteOnce
  size: 1Gi
  annotations: {}

# Setup Job configuration
# Runs setup.sh as a one-time initialization job during Helm install
setup:
  # Enable setup job (runs on first install only via Helm hook)
  enabled: true
  # Number of retries if setup fails
  backoffLimit: 3
  # Whether to preserve the setup job after completion
  # When false: Job is deleted immediately on success, and after ttlSecondsAfterFinished on failure
  # When true: Job is kept indefinitely (ttlSecondsAfterFinished is not applied)
  preserveJob: false
  # Time to keep failed jobs after completion (seconds, 0 = indefinite)
  # Only applies when preserveJob=false. Successful jobs are deleted immediately via hook-delete-policy.
  ttlSecondsAfterFinished: 86400  # 24 hours
  # Enable debug mode for setup
  debug: false
  # Additional command-line arguments for setup.sh
  args: []
    # Example:
    # - "--debug"
  # Additional environment variables for setup job
  env: []
    # Example:
    # - name: BOOTSTRAP_FAIL_FAST
    #   value: "true"
    # - name: BOOTSTRAP_SKIP_PATTERN
    #   value: "test"
  # Resource limits for setup job
  resources:
    limits:
      cpu: 500m
      memory: 256Mi
    requests:
      cpu: 250m
      memory: 128Mi
  # Additional volume mounts for setup job
  extraVolumeMounts: []
    # Example:
    # - name: secrets
    #   mountPath: /run/secrets
    #   readOnly: true
  # Additional volumes for setup job
  extraVolumes: []
    # Example:
    # - name: secrets
    #   secret:
    #     secretName: thunder-secrets

# Bootstrap configuration
# Custom bootstrap scripts extend Thunder's setup process by adding initialization logic.
#
# ⚠️ IMPORTANT: Bootstrap patterns are MUTUALLY EXCLUSIVE
#   Choose ONE pattern only. Using both 'scripts' and 'configMap' will fail validation.
#
#   - Pattern 1: Use 'scripts' for inline scripts
#   - Pattern 2 OR 3: Use 'configMap' (with or without 'files')
#
bootstrap:
  # Pattern 1: Inline bootstrap scripts (key: filename, value: script content)
  # Each script will be mounted individually using subPath to preserve default scripts
  scripts: {}
    # Example - Creating custom users:
    # 20-custom-users.sh: |
    #   #!/bin/bash
    #   set -e
    #   # Source common functions (provides log_* and thunder_api_call)
    #   SCRIPT_DIR="$(dirname "${BASH_SOURCE[0]:-$0}")"
    #   source "${SCRIPT_DIR}/common.sh"
    #
    #   log_info "Creating custom users..."
    #   thunder_api_call POST "/users" '{
    #     "type": "person",
    #     "attributes": {
    #       "username": "alice",
    #       "password": "alice123",
    #       "sub": "alice",
    #       "email": "alice@example.com",
    #       "name": "Alice Johnson"
    #     }
    #   }'
    #   log_success "Custom users created"
    #
  # Pattern 2 & 3: Reference an external ConfigMap with bootstrap scripts
  #
  # Behavior depends on whether 'files' is specified:
  # - WITH files list: Mounts only specified files (preserves defaults) - Pattern 2
  # - WITHOUT files (empty/omitted): Mounts entire ConfigMap (replaces all defaults) - Pattern 3
  #
  # Example 1 - Pattern 2: Add specific scripts (preserves defaults)
  #   configMap:
  #     name: "my-bootstrap"
  #     files:
  #       - 30-custom-users.sh
  #       - 40-custom-apps.sh
  #
  # Example 2 - Pattern 3: Replace all scripts
  #   configMap:
  #     name: "complete-bootstrap"
  #     # No files = replaces all defaults (must provide your own common.sh)
  #
  configMap:
    # Name of the ConfigMap containing bootstrap scripts
    name: ""
    # List of script filenames to mount from the ConfigMap
    # If empty/omitted: mounts entire ConfigMap (replaces all defaults - Pattern 3)
    # If specified: mounts only these files (preserves defaults - Pattern 2)
    files: []
