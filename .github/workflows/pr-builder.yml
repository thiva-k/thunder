# This workflow will build the project on pull requests with tests
# Uses:
#   OS: ubuntu-latest
#   Go: go 1.x

name: üë∑üõ†Ô∏è PR Builder

on:
  pull_request:
  workflow_dispatch:

env:
  GOFLAGS: "-mod=readonly"

jobs:
  lint:
    name: üßπ Lint Code
    if: ${{ github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4
        with:
          # We need to fetch all branches and commits so that Nx affected has a base to compare against.
          fetch-depth: 0

      - name: ‚öôÔ∏è Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'

      - name: üê≥ Set SHAs for Nx
        id: set-shas
        uses: nrwl/nx-set-shas@v3
        with:
          main-branch-name: "main"

      - name: üì¶ Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 'latest'
          run_install: false
          cache: true
          cache-dependency-path: frontend/pnpm-lock.yaml

      - name: ‚öôÔ∏è Set up Go Environment
        uses: ./.github/actions/setup-go

      - name: üì¶ Prepare golangci-lint Locally
        run: make golangci-lint

      - name: üîç Run Backend Linter
        run: make lint_backend

      - name: üß© Install Dependencies & Build Frontend
        run: |
          cd frontend
          pnpm install --frozen-lockfile
          pnpm build

      - name: üîç Run Frontend Linter
        run: |
          cd frontend
          pnpm nx affected --target=lint --parallel=3 --base=${{ env.NX_BASE }} --head=${{ env.NX_HEAD }}

  build:
    name: üõ†Ô∏è Build Product
    if: ${{ github.event.label.name == 'trigger-pr-builder' || github.event_name == 'workflow_dispatch' || github.event_name == 'pull_request'}}
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Set up Go Environment
        uses: ./.github/actions/setup-go

      - name: ‚öôÔ∏è Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'

      - name: üì¶ Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: '9.x'
          run_install: false
          cache-dependency-path: frontend/pnpm-lock.yaml

      - name: üóÑÔ∏è Cache Go Modules
        uses: actions/cache@v4
        id: cache-go-modules
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-modules-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-modules-

      - name: üì¶ Install Backend Dependencies
        run: |
          cd backend
          go mod download
          cd ../tests/integration
          go mod download

      - name: üì¶ Install Frontend Dependencies
        run: |
          cd frontend
          pnpm install --frozen-lockfile

      - name: üßπ Clean Previous Builds
        run: |
          set -e
          make clean

      - name: üî® Build Frontend
        run: |
          cd frontend
          pnpm build

      - name: üî® Build Product with Coverage
        run: |
          set -e
          export LOG_LEVEL=debug
          make build_with_coverage_only OS=$(go env GOOS) ARCH=$(go env GOARCH)

          # Find the built distribution
          DIST_PATH=$(find target/dist -name "thunder-*.zip" | head -1)
          echo "Built distribution: $DIST_PATH"

      - name: üß™ Run Frontend Tests with Coverage
        run: |
          cd frontend/apps/thunder-develop
          pnpm test:coverage

      - name: üì¶ Upload Built Distribution
        uses: actions/upload-artifact@v4
        with:
          name: thunder-distribution
          path: target/dist/*.zip
          if-no-files-found: error

      - name: üìä Upload Unit Test Coverage Report to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: backend/coverage_unit.out
          disable_search: true
          flags: backend-unit
          name: Backend Unit Tests
          fail_ci_if_error: false

      - name: üì¶ Archive Unit Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: unit-coverage-report
          path: backend/coverage_unit.out
          if-no-files-found: error

      - name: üìä Upload `@thunder/develop` Unit Test Coverage Report to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: frontend/apps/thunder-develop/coverage/lcov.info
          disable_search: true
          flags: frontend-apps-develop-unit
          name: Frontend Develop App Unit Tests
          fail_ci_if_error: false

  test-integration:
    name: üß™ Integration Tests (${{ matrix.database }})
    needs: build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        database: [sqlite, postgres]
      fail-fast: false
    services:
      postgres:
        image: postgres:latest
        env:
          POSTGRES_USER: asgthunder
          POSTGRES_PASSWORD: asgthunder
          POSTGRES_DB: thunderdb
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Set up Go Environment
        uses: ./.github/actions/setup-go

      - name: üì• Download Unit Coverage Report
        uses: actions/download-artifact@v4
        with:
          name: unit-coverage-report
          path: backend/

      - name: üóÑÔ∏è Cache Go Modules
        uses: actions/cache@v4
        id: cache-go-modules
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-modules-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-modules-

      - name: üì¶ Install Dependencies
        run: |
          cd backend
          go mod download
          cd ../tests/integration
          go mod download

      - name: üìù Configure Test Database
        run: |
          chmod +x tests/integration/resources/scripts/setup-test-config.sh
          ./tests/integration/resources/scripts/setup-test-config.sh
        env:
          DB_TYPE: ${{ matrix.database }}

      - name: üß™ Run Integration Tests (${{ matrix.database }})
        uses: ./.github/actions/run-integration-tests
        with:
          database-type: ${{ matrix.database }}
          coverage-enabled: true

      - name: üìä Upload Integration Test Coverage Report to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: target/coverage_integration.out
          disable_search: true
          flags: backend-integration-${{ matrix.database }}
          name: Backend Integration Tests (${{ matrix.database }})
          fail_ci_if_error: false

      # - name: üß© Generate Combined Coverage Report
      #   run: ./build.sh merge_coverage

      # - name: üìä Upload Combined Coverage Report to Codecov
      #   uses: codecov/codecov-action@v4
      #   with:
      #     token: ${{ secrets.CODECOV_TOKEN }}
      #     files: target/coverage_combined.out
      #     disable_search: true
      #     flags: backend-combined-${{ matrix.database }}
      #     name: Backend-combined Coverage (${{ matrix.database }})
      #     fail_ci_if_error: false

  test-e2e:
    name: üé≠ Playwright E2E Tests
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'

      - name: üì• Download Built Distribution
        uses: actions/download-artifact@v4
        with:
          name: thunder-distribution
          path: target/dist/

      - name: üìÇ Extract Server to E2E
        run: |
          mkdir -p tests/e2e/thunder-server
          unzip target/dist/thunder-*.zip -d tests/e2e/thunder-server
          cd tests/e2e/thunder-server
          EXTRACTED_DIR=$(find . -maxdepth 1 -type d -name "thunder-*" | head -n 1)
          if [ -n "$EXTRACTED_DIR" ]; then
            mv "$EXTRACTED_DIR"/* .
            rmdir "$EXTRACTED_DIR"
          fi
          chmod +x setup.sh start.sh
          echo "üìÇ Server structure after extraction:"
          ls -F
          echo "üìÇ Frontend apps found:"
          ls -R apps/ 2>/dev/null || echo "‚ùå apps directory missing!"

      - name: üöÄ Start Thunder Server
        run: |
          cd tests/e2e/thunder-server
          ./setup.sh
          ./start.sh &
          # Wait for server to be ready
          echo "Waiting for server to be ready on https://localhost:8090..."
          for i in {1..60}; do
            if curl -s -k https://localhost:8090/health/liveness > /dev/null; then
              echo "Server is UP!"
              exit 0
            fi
            echo "Still waiting ($i/60)..."
            sleep 2
          done
          echo "Server failed to start within 2 minutes"
          exit 1

      - name: üì¶ Install E2E Dependencies
        run: npm ci
        working-directory: tests/e2e

      - name: üé≠ Install Playwright Browsers
        run: npx playwright install --with-deps
        working-directory: tests/e2e

      - name: üß™ Run Playwright Tests
        run: npx playwright test
        working-directory: tests/e2e
        env:
          BASE_URL: https://localhost:8090
          ADMIN_USERNAME: ${{ secrets.PLAYWRIGHT_ADMIN_USERNAME || 'admin' }}
          ADMIN_PASSWORD: ${{ secrets.PLAYWRIGHT_ADMIN_PASSWORD || 'admin' }}
          TEST_USER_USERNAME: ${{ secrets.PLAYWRIGHT_TEST_USER_USERNAME || 'testuser' }}
          TEST_USER_PASSWORD: ${{ secrets.PLAYWRIGHT_TEST_USER_PASSWORD || 'admin' }}
          PLAYWRIGHT_WORKERS: ${{ vars.PLAYWRIGHT_WORKERS || 1 }}

      - name: üìä Upload Playwright Report
        uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: playwright-report
          path: tests/e2e/playwright-report/
          retention-days: 30

  detect-powershell-changes:
    name: üîç Detect PowerShell Changes
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    outputs:
      should-run: ${{ steps.filter.outputs.powershell }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            powershell:
              - '**.ps1'
              - '.github/workflows/windows-powershell-validation.yml'
      - name: ‚úÖ PowerShell files detected
        if: steps.filter.outputs.powershell == 'true'
        run: echo "PowerShell files changed - validation will run"
      - name: ‚è≠Ô∏è No PowerShell changes
        if: steps.filter.outputs.powershell != 'true'
        run: echo "No PowerShell changes - skipping validation"

  validate-windows:
    name: ü™ü Validate Windows PowerShell
    needs: detect-powershell-changes
    if: needs.detect-powershell-changes.outputs.should-run == 'true'
    uses: ./.github/workflows/windows-powershell-validation.yml
  