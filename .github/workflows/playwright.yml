name: Playwright Tests
on:
  push:
    branches: [ main, master ]
jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: âš™ï¸ Set up Go Environment
      uses: ./.github/actions/setup-go

    - name: âš™ï¸ Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: lts/*

    - name: ðŸ“¦ Install pnpm
      uses: pnpm/action-setup@v4
      with:
        version: '9.x'
        run_install: false

    - name: ðŸ› ï¸ Build Product
      run: make build

    - name: ðŸ“‚ Extract Server to E2E
      run: |
        mkdir -p tests/e2e/thunder-server
        unzip target/dist/thunder-*.zip -d tests/e2e/thunder-server
        cd tests/e2e/thunder-server
        # Find the extracted folder (name includes version and arch) and move its contents to the root of tests/e2e/thunder-server
        EXTRACTED_DIR=$(find . -maxdepth 1 -type d -name "thunder-*" | head -n 1)
        if [ -n "$EXTRACTED_DIR" ]; then
          mv "$EXTRACTED_DIR"/* .
          rmdir "$EXTRACTED_DIR"
        fi
        chmod +x setup.sh start.sh

    - name: ðŸš€ Start Thunder Server
      run: |
        cd tests/e2e/thunder-server
        ./setup.sh
        THUNDER_SKIP_SECURITY=true ./start.sh &
        # Wait for server to be ready
        echo "Waiting for server to be ready on https://localhost:8090..."
        for i in {1..60}; do
          if curl -s -k https://localhost:8090/health/liveness > /dev/null; then
            echo "Server is UP!"
            break
          fi
          echo "Still waiting ($i/60)..."
          sleep 2
        done
        
        # Verify server is actually running
        if ! curl -s -k https://localhost:8090/health/liveness > /dev/null; then
          echo "Server failed to start within 2 minutes"
          exit 1
        fi
        
        echo "Server started successfully!"
    
    - name: ðŸ” Extract Sample App ID
      id: extract-app-id
      run: |
        echo "Fetching applications from Thunder..."
        
        # Get applications list
        APPS_RESPONSE=$(curl -s -k https://localhost:8090/applications)
        
        # Extract Sample App ID using jq
        SAMPLE_APP_ID=$(echo "$APPS_RESPONSE" | jq -r '.applications[] | select(.name == "Sample App") | .id')
        
        if [ -z "$SAMPLE_APP_ID" ] || [ "$SAMPLE_APP_ID" == "null" ]; then
          echo "âš ï¸  Warning: Sample App not found in applications list"
          echo "Available applications:"
          echo "$APPS_RESPONSE" | jq -r '.applications[] | "  - \(.name) (\(.id))"'
          echo "sample_app_id=" >> $GITHUB_OUTPUT
        else
          echo "âœ“ Sample App ID extracted: $SAMPLE_APP_ID"
          echo "sample_app_id=$SAMPLE_APP_ID" >> $GITHUB_OUTPUT
        fi
    
    - name: ðŸ”„ Restart Thunder Server with Security Enabled
      run: |
        cd tests/e2e/thunder-server
        
        echo "Stopping Thunder server..."
        # Find and kill the Thunder server process
        pkill -f "thunder.*server" || true
        
        # Wait for process to fully terminate
        sleep 3
        
        echo "Starting Thunder server with security enabled..."
        ./start.sh &
        
        # Wait for server to be ready
        echo "Waiting for server to be ready on https://localhost:8090..."
        for i in {1..60}; do
          if curl -s -k https://localhost:8090/health/liveness > /dev/null; then
            echo "Server is UP with security enabled!"
            break
          fi
          echo "Still waiting ($i/60)..."
          sleep 2
        done
        
        # Verify server is actually running
        if ! curl -s -k https://localhost:8090/health/liveness > /dev/null; then
          echo "Server failed to restart within 2 minutes"
          exit 1
        fi
        
        echo "Server restarted successfully with security enabled!"
    
    - name: ðŸ“± Extract and Start Sample App
      run: |
        echo "Extracting Sample App..."
        mkdir -p tests/e2e/sample-app
        
        # Find the sample app zip file (platform-specific)
        SAMPLE_APP_ZIP=$(find target/dist -name "sample-app-react-sdk-*.zip" | head -n 1)
        
        if [ -z "$SAMPLE_APP_ZIP" ]; then
          echo "âš ï¸  Warning: Sample app zip not found in target/dist"
          echo "Available files:"
          ls -la target/dist/
          exit 1
        fi
        
        echo "Found sample app: $SAMPLE_APP_ZIP"
        unzip -q "$SAMPLE_APP_ZIP" -d tests/e2e/sample-app
        
        cd tests/e2e/sample-app
        
        # Find the extracted folder and move its contents
        EXTRACTED_DIR=$(find . -maxdepth 1 -type d -name "sample-app-*" | head -n 1)
        if [ -n "$EXTRACTED_DIR" ]; then
          mv "$EXTRACTED_DIR"/* .
          rmdir "$EXTRACTED_DIR"
        fi
        
        # Make start script executable
        chmod +x start.sh
        
        echo "Starting Sample App..."
        ./start.sh &
        
        # Wait for sample app to be ready
        echo "Waiting for sample app to be ready on https://localhost:3000..."
        for i in {1..60}; do
          if curl -s -k https://localhost:3000 > /dev/null 2>&1; then
            echo "Sample App is UP!"
            break
          fi
          echo "Still waiting ($i/60)..."
          sleep 2
        done
        
        # Verify sample app is running
        if ! curl -s -k https://localhost:3000 > /dev/null 2>&1; then
          echo "Sample app failed to start within 2 minutes"
          exit 1
        fi
        
        echo "Sample App started successfully!"

    - name: Install E2E dependencies
      run: npm ci
      working-directory: tests/e2e

    - name: Install Playwright Browsers
      run: npx playwright install --with-deps
      working-directory: tests/e2e

    - name: Run Playwright tests
      run: npx playwright test
      working-directory: tests/e2e
      env:
        # Configuration Priority: Secret > Variable > Hardcoded Default
        BASE_URL: ${{ secrets.PLAYWRIGHT_BASE_URL || vars.PLAYWRIGHT_BASE_URL || 'https://localhost:8090' }}
        ADMIN_USERNAME: ${{ secrets.PLAYWRIGHT_ADMIN_USERNAME || 'admin' }}
        ADMIN_PASSWORD: ${{ secrets.PLAYWRIGHT_ADMIN_PASSWORD || 'admin' }}
        TEST_USER_USERNAME: ${{ secrets.PLAYWRIGHT_TEST_USER_USERNAME || 'testuser' }}
        TEST_USER_PASSWORD: ${{ secrets.PLAYWRIGHT_TEST_USER_PASSWORD || 'admin' }}
        PLAYWRIGHT_WORKERS: ${{ vars.PLAYWRIGHT_WORKERS || 1 }}
        DEBUG_AUTH: ${{ vars.PLAYWRIGHT_DEBUG_AUTH || 'false' }}
        # MFA Test Configuration
        SAMPLE_APP_ID: ${{ steps.extract-app-id.outputs.sample_app_id }}
        SAMPLE_APP_URL: 'https://localhost:3000'
        THUNDER_URL: 'https://localhost:8090'
        AUTO_SETUP_MFA: ${{ vars.AUTO_SETUP_MFA || 'true' }}
        MOCK_SMS_SERVER_PORT: ${{ vars.MOCK_SMS_SERVER_PORT || 8098 }}
        SAMPLE_APP_USERNAME: ${{ secrets.SAMPLE_APP_USERNAME || 'e2e-test-user' }}
        SAMPLE_APP_PASSWORD: ${{ secrets.SAMPLE_APP_PASSWORD || 'e2e-test-password' }}

    - uses: actions/upload-artifact@v4
      if: ${{ !cancelled() }}
      with:
        name: playwright-report
        path: tests/e2e/playwright-report/
        retention-days: 30
