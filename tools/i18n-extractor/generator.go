/*
 * Copyright (c) 2025, WSO2 LLC. (https://www.wso2.com).
 *
 * WSO2 LLC. licenses this file to you under the Apache License,
 * Version 2.0 (the "License"); you may not use this file except
 * in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */

package main

import (
	"fmt"
	"os"
	"path/filepath"
	"sort"
	"strings"
	"text/template"
)

// Generator generates the defaults.go file from extracted messages.
type Generator struct{}

// NewGenerator creates a new Generator instance.
func NewGenerator() *Generator {
	return &Generator{}
}

// Generate creates the defaults.go file with all extracted messages.
func (g *Generator) Generate(messages []ExtractedMessage, outputPath string) error {
	// Ensure the output directory exists
	dir := filepath.Dir(outputPath)
	if err := os.MkdirAll(dir, 0755); err != nil {
		return fmt.Errorf("failed to create output directory: %w", err)
	}

	// Deduplicate messages by key (last one wins)
	messageMap := make(map[string][]ExtractedMessage)
	for _, msg := range messages {
		messageMap[msg.Key] = append(messageMap[msg.Key], msg)
	}

	// Check for duplicates
	var duplicateErrors []string
	for key, msgs := range messageMap {
		if len(msgs) > 1 {
			var locations []string
			for _, msg := range msgs {
				locations = append(locations, fmt.Sprintf("%s:%d", msg.SourceFile, msg.Line))
			}
			duplicateErrors = append(duplicateErrors, fmt.Sprintf("Key %q is defined %d times:\n\t- %s", key, len(msgs), strings.Join(locations, "\n\t- ")))
		}
	}

	if len(duplicateErrors) > 0 {
		return fmt.Errorf("duplicate keys found:\n%s", strings.Join(duplicateErrors, "\n"))
	}

	// Sort keys for consistent output
	keys := make([]string, 0, len(messageMap))
	for k := range messageMap {
		keys = append(keys, k)
	}
	sort.Strings(keys)

	// Prepare template data
	type MessageEntry struct {
		Key          string
		DefaultValue string
		SourceFile   string
		Line         int
	}

	sortedMessages := make([]MessageEntry, 0, len(keys))
	for _, k := range keys {
		msg := messageMap[k][0] // Take the first one since we are sure there are no duplicates now
		sortedMessages = append(sortedMessages, MessageEntry{
			Key:          msg.Key,
			DefaultValue: msg.DefaultValue,
			SourceFile:   msg.SourceFile,
			Line:         msg.Line,
		})
	}

	data := struct {
		Messages []MessageEntry
	}{
		Messages: sortedMessages,
	}

	// Create output file
	file, err := os.Create(outputPath)
	if err != nil {
		return fmt.Errorf("failed to create output file: %w", err)
	}
	defer file.Close()

	// Execute template
	tmpl, err := template.New("defaults").Funcs(template.FuncMap{
		"escape": escapeString,
	}).Parse(defaultsTemplate)
	if err != nil {
		return fmt.Errorf("failed to parse template: %w", err)
	}

	if err := tmpl.Execute(file, data); err != nil {
		return fmt.Errorf("failed to execute template: %w", err)
	}

	return nil
}

// escapeString escapes a string for use in Go source code.
func escapeString(s string) string {
	s = strings.ReplaceAll(s, "\\", "\\\\")
	s = strings.ReplaceAll(s, "\"", "\\\"")
	s = strings.ReplaceAll(s, "\n", "\\n")
	s = strings.ReplaceAll(s, "\t", "\\t")
	s = strings.ReplaceAll(s, "\r", "\\r")
	return s
}

const defaultsTemplate = `// Code generated by i18n-extractor. DO NOT EDIT.
// Run 'make generate_i18n' to regenerate.

/*
 * Copyright (c) 2025, WSO2 LLC. (https://www.wso2.com).
 *
 * WSO2 LLC. licenses this file to you under the Apache License,
 * Version 2.0 (the "License"); you may not use this file except
 * in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */

package core

// defaultMessages contains all i18n keys extracted from source code.
// This map is populated by the i18n extraction script at build time.
// Helper functions for accessing these messages are in helpers.go.
var defaultMessages = map[string]string{
{{- range .Messages}}
	"{{escape .Key}}": "{{escape .DefaultValue}}",
{{- end}}
}
`
